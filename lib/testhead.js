Trie = require('merkle-patricia-tree');
rlp = require('rlp');
levelup = require('levelup');
EthereumTx = require('ethereumjs-tx');
// db = levelup('/Users/zacharymitton/Library/Ethereum/geth/chaindata');
sha3 = require('js-sha3').keccak_256

numToBuf = (input)=>{ return new Buffer(byteable(input.toString(16)), "hex") }
stringToBuf = (input)=>{ return new Buffer(byteable(input.slice(2)), "hex") }
byteable = (input)=>{ return input.length % 2 == 0 ? input : "0" + input }



b = {  
  "difficulty":"0x2",
  "extraData":"0xd783010607846765746887676f312e372e33856c696e7578000000000000000095dfadba901e40820a943f377b19fc7e9104160aaef7dc817902267fed61178e071423b6bb0a4e94510b8a8054863d69a58b4e8c19f1c78be8ac219362579f6f00",
  "gasLimit":"0x47e7bf",
  "gasUsed":"0x1dfc2",
  "hash":"0x8645f39ba3aec313c9d5ddd828275c8e0252653b2f57468642bc7986a55bc56d",
  "logsBloom":"0x004000400400400100000000000000000000000100000000000000000000000000000000000000000000800000000000000000000000008000002800000000040000000000002000000000000000000000000000000000000000000a0000002000000000000000000000000000000020000000000204000002000000000000000080000000000000400000000000400180200000000000000000000000000000000000000000000000000000000000000809000000000000000000000000080000000000000000000000000000044000020000000000002100000000000000001000000400000000000000000000040000000000020000000000000000000000",
  "miner":"0x0000000000000000000000000000000000000000",
  "mixHash":"0x0000000000000000000000000000000000000000000000000000000000000000",
  "nonce":"0x0000000000000000",
  "number":"0x6c6c3",
  "parentHash":"0x6f7c788b90078720262235ba0aa131a14ba63d3b89bdb31e0deb82979b8b51a8",
  "receiptsRoot":"0x8363f49c42c2bb31242bd0e5895fffec8194a977de5c4d05efc475ab49767fcf",
  "sha3Uncles":"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
  "size":"0x501",
  "stateRoot":"0x17c210e76a232c73abd26ffc078ebef63c5d98a28a85c9ef539edf5417651c08",
  "timestamp":"0x5953eead",
  "totalDifficulty":"0xd15f2",
  "transactions":[  
    {  
      "blockHash":"0x8645f39ba3aec313c9d5ddd828275c8e0252653b2f57468642bc7986a55bc56d",
      "blockNumber":"0x6c6c3",
      "from":"0x9e3d69305da51f34ee29bfb52721e3a824d59e69",
      "gas":"0x3d0900",
      "gasPrice":"0x4a817c800",
      "hash":"0x5973bea6f876344f04fe571f3fc8c13415ff8ca2bb92858ad9864955fece8d38",
      "input":"0x82ab890a0000000000000000000000000000000000000000000000000000000000002c0a",
      "nonce":"0x4f20",
      "to":"0xaca0cc3a6bf9552f2866ccc67801d4e6aa6a70f2",
      "transactionIndex":"0x0",
      "value":"0x0",
      "v":"0x1b",
      "r":"0x16d4490d54f566f6bc91fe1ebdf6680d12ca64ddac1ca1d3362f61f20916a790",
      "s":"0x4530a50f5d2b7244979b9909b406034dcee53c0f21b375eb5ac963e5f388c01f"
    },
    {  
      "blockHash":"0x8645f39ba3aec313c9d5ddd828275c8e0252653b2f57468642bc7986a55bc56d",
      "blockNumber":"0x6c6c3",
      "from":"0xfecf173d626acf0ca4d6b61a8b7bf6811d43fcfe",
      "gas":"0x2dc6c0",
      "gasPrice":"0x4a817c800",
      "hash":"0x22a48fb43fc9747218d99d8fa2346ed0a4a51657a00a51f9f665a9762ea6ff5e",
      "input":"0xd7f31eb90000000000000000000000000271300f2890360ae8989785d7a8ca986a92d4c9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104d7f31eb90000000000000000000000002cc31912b2b0f3075a87b3640923d45a26cef3ee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000064d79d8e6c75506f727450726f66696c654950465331323230000000000000000000000000000000000000000000000000122bd1a75ae8c741f7e2ab0a28bd30b8dbb1a67e8ebacdb7c2039ea441445fb27612d6abda3a429d0e64d244295b4542990ad9760000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
      "nonce":"0x5",
      "to":"0xb525eace21bd1a7b6da3934ea3bb030d8e8f388c",
      "transactionIndex":"0x1",
      "value":"0x0",
      "v":"0x1b",
      "r":"0x95b3bbafa85890ac10cea75df22142ebbb5b703120ecbf177731190c7b59b8d5",
      "s":"0x1adad3ca3533592571cf93a86fe8691337d1b2b276f7d6bacb34a9724c354396"
    }
  ],
  "transactionsRoot":"0xbe473877467a837b676a7f94ef034e4e7daa733ed1152d0c8d399a193311076a",
  "uncles":[]
}

//no transactions => "transactionsRoot":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421"
//1 transaction =>
// "transactionsRoot":"0x4269cc35ce441c0b7574c4c2028b5d69eeda801d3ecbb675c9924831a4a6fb24"

// "transactions":[{
//   "blockHash":"0x4bc1f712c62e2b799e4bce190535b914a46a57f9e321ebf4c7c4819afb66b091",
//   "blockNumber":"0x5af37",
//   "from":"0xec8d53b9a6498433a6d675623c564aa3257c128a",
//   "gas":"0x478de2",
//   "gasPrice":"0x4a817c800",
//   "hash":"0x34e7814f002c012112136d878e297a520a310dd51c249e5aac0715ec2165df7a",
//   "input":"0x7f6715c90000000000000000000000000000000000000000000000000000000000000003",
//   "nonce":"0x28e","to":"0xa6ae7c17bbbd41636381e76830f902872aaea9f9",
//   "transactionIndex":"0x0",
//   "value":"0x0",
//   "v":"0x1b",
//   "r":"0x582f163129f537fce70e1a500fee8f85e777185b6ee94010edaba870d80ad70d",
//   "s":"0x871ce3c40fd822b24f1e0f7827c374198bec8f91879d9a82c7246a4ebc265ce"}]

// another rinkeby block with only 1 tx below
// rawsignedtx = f86b01850df8475800825208941f4e7db8514ec4e99467a8d2ee3a63094a904e7a8727147114878000802ba0a3979536559de41c32fccfeadb067a270877e0db4a091dbd6b849fcfc2d83c66a0019fef106dece528ced299ad26da57061e72208ba081b5761faee20e8521375e
// txhash = "3020771151af5fbada08586a6f2d1be4cf0c59c6abbcd6891f796bdebe3c4c62"
// transactions = [{"blockHash":"0xf3c96c423b25316d7d46d8670bd45bebd5ebd3d9976183f43b32078024d10852","blockNumber":"0x6e001","from":"0x9bee04ec5cc9890dae29780421874b85b0a20c99","gas":"0x5208","gasPrice":"0xdf8475800","hash":"0x3020771151af5fbada08586a6f2d1be4cf0c59c6abbcd6891f796bdebe3c4c62","input":"0x","nonce":"0x1","to":"0x1f4e7db8514ec4e99467a8d2ee3a63094a904e7a","transactionIndex":"0x0","value":"0x27147114878000","v":"0x2b","r":"0xa3979536559de41c32fccfeadb067a270877e0db4a091dbd6b849fcfc2d83c66","s":"0x19fef106dece528ced299ad26da57061e72208ba081b5761faee20e8521375e"}]
// transactionsRoot:"0xec19e58128436bfc51933ba31b8a82e65fa742531e352015b6da81436426ad16"



blockHeader = (block)=>{
  return [
    stringToBuf(block.parentHash),
    stringToBuf(block.sha3Uncles),
    stringToBuf(block.miner),
    stringToBuf(block.stateRoot),
    stringToBuf(block.transactionsRoot),
    stringToBuf(block.receiptsRoot),
    stringToBuf(block.logsBloom),
    stringToBuf(block.difficulty),
    stringToBuf(block.number),
    stringToBuf(block.gasLimit),
    stringToBuf(block.gasUsed),
    stringToBuf(block.timestamp),
    stringToBuf(block.extraData),
    stringToBuf(block.mixHash),
    stringToBuf(block.nonce)
  ]
}


txsroot = b.transactionsroot // '0x...'

txTrie = new Trie();



// txs = ["0xb53f752216120e8cbe18783f41c6d960254ad59fac16229d4eaec5f7591319de", "0x213b50ce067f9e21d0291b1ff81054778b9ec24c2942006143b20853f208977f", "0x370a63f5b17223557c4e6d5e0589c816700db9c48d5348cbd51a696adb759348", "0x23677909f2b13162bc8d2ec6ed9b6f78b15aa2c52fc1dd94bb007471c89a6766", "0x26bdf87d1d309a1dc8ca4c01849f8ac02a4a20d941d37e07012119c78c0a111e", "0x81520aff707fc7c3a2b4fbed617b94d1697e2ba596ef8c2d9fb9c22cc5672a43", "0x26599906997b319b7de9602bec0da6492a103dbd0c7fbd0a131f20b649afefc3", "0x22ca78b052858b2db0c06b454ca9dee4b6eef96f3ab10e8e33b3434d77ab2da2", "0x723d58874948cdc24008de75d5d17f6710398ffacfedefd1985ea53d63234a1e", "0x9aa2e1ecc0bb021d6ea8c11e13e6703eefb6bd1774a30bd32f6c038d95b4a201", "0x30ac2d668a5bf323e13dfea58418e7e9edcdde0eb2879d9ae28a0207fa37b96d", "0xd1107e2d25d2b148af3a7d7488bf207ad037f2e3d3bf46fb5971fda15d452c2a", "0xed8b9f2b4fc82d29ae0fc83a0463c12d8feb09ca029d5868e5421206fed621d3", "0xce461d755fdf398aeb9d1453410553ebdc79eec12f20710369db5d59707460a0", "0xda203ca6f64aada9b83f8e9ce237b62e8017c9b89feb248ca4983d6e0d19b69f", "0x8c4897d5b333e76dd30079cea296dd6bc30da89d748f8ff3adefb240eca40347", "0x8b1dd34a2c0517c0719516cf5ed076a1e50b4d707fd57a99e91ae012636c3938", "0x5df17d41a625856221c005d3ed8062a24a3640194ef47b138f57b04c733c0e0f", "0x9d1b2df52bf07ca5984c228f81fc30fe8c55b0648c4370d87b7fd534f51a1b50", "0x7dd9bdd4fd0f45595d0335cec81b7d4f30bd88e37f8ca9e1466d674e88bfcd1c", "0xefe1db71ec1453efb81ab5996b74578fa4f7b4301e6d2a4de47b0dce5538b88e", "0x7c9cf78f89befd42332bf13d5afb5f27f14912739c3cca9a430c11c45837ce28", "0xfdfd8aaa10f2f163fe50ff2673f4244cd8feda948d9c315211a98e16ab2cc22c", "0xa02942c77283fb3729998110e8bd3a928004805c34aa92456199b98212faa1cc", "0xef081ed9504f4f5b65d1c3e5fd785cd22aefbf12a6d7474ba944a059630021b3", "0xdedb78eafff7c0245e35946e7da98fc91ad70b9d08a771d26ba1015f560264b2", "0x479937d6f52085d8c6f66d2bb970aa1ab471f7ac5cc33f31212e77c89121826a", "0xff771ba9bed5780aace7e5fff7f57b79f5a8cc3b3a009b738b4a4746b7bc1ad7", "0x0e8bab6b196348d74be74889f8e5ce1f5667541db04ac5ed3ce18834fdfd6d50", "0xcf3776cc13ecb085a56886aab03fda06df6ad365577fc9022ab80662f126b25f", "0xa462070c88654b2ddeade9f547608d7e77c0f68badca7e2165f5c1bc0299279f", "0xb71a7a7ea6bcbc4082cd90c7db77ce2ac4c0ebad660a2cac5448db4d20c0a480", "0xb965c502751930d9aa88a1ef2c65fd3a501ef783c3518e22204db282790ec151", "0x4d90625016e0ce922d75ae9c194befcb86ffc7e5aeb9c7611b9b8d2e2b84913e", "0x1611e5289d825b36dc2abc00d4f3021478f33f855164f0716af7c791b09d9331", "0xadeb8902188bebe1cb05f80a43290c8fd035fef23736a41d5af2b336df883ab7", "0x0536644f2761f556dd12f9b7589630bca65eb08748725c441e199bcffe22eeee", "0xb10f5d7dc90bd6ea3580057fb4cd9e83400314fdcdf3e9348eb958b25162e50a", "0x4716d03427cafb180c5763d53d64d07cb211844dcd9191a0267f6e650a3b58bc", "0x79eb2735d2a82b17eb994c5a1416a09dbb1a4e33ce88c84dafeb586b0bf09f22", "0xe58ac28c7232dbed9822689d71332bc9d2caaf5aab661023732135e31a657feb", "0xf094fc91eb5026e7e564ae9d917707b1a561433e6ca494ae8c24a7e2243fabc0", "0x96398efa104999a9bad97af319fb4525eb73c394a8ec0b69afcd53260da83829", "0x767257c82cc225b1a8c5a4b125cfd1dc135ab39f4815ae8d8bd902e6e45a836c", "0xd4a6906a2a90fd23a9c24b193606232049d24f8ca4ada8c4100d2f3f8db71b5e", "0xeaac8b205a00741e7c9e571398be946ec172420ff8067e0f2a26064efd6b6ab8", "0xc58a8588674ab3f51983b8e7350dfd1a0304e4fff6fa9b0065cda4493427d01e"];
// txHash = "0x76de858022a0904dbc0d6ed58f42423abe3b3ced468f81636d52c74d2186efa3";

// tx0 = 'b53f752216120e8cbe18783f41c6d960254ad59fac16229d4eaec5f7591319de'
// tx0buf = new Buffer(tx0,'hex')


// putTx = (i, txHash)=>{
//   db.get(new Buffer(txs[i].slice(2),'hex'), {encoding: 'binary'}, function (err, rawSignedTx) {
//     console.log(txTrie.root, i)
//     txTrie.put(rlp.encode(0), rawSignedTx, {encoding: 'binary'}, function (err, value) {
//       console.log("HI", i)
//     })
//   })
// }






x0 = new EthereumTx(b.transactions[0])
t0 = x0.serialize()
console.log(sha3(t0))

x1 = new EthereumTx(b.transactions[1])
t1 = x1.serialize()
console.log(sha3(t1))

trie = new Trie()
// t  = new Buffer("f86b01850df8475800825208941f4e7db8514ec4e99467a8d2ee3a63094a904e7a8727147114878000802ba0a3979536559de41c32fccfeadb067a270877e0db4a091dbd6b849fcfc2d83c66a0019fef106dece528ced299ad26da57061e72208ba081b5761faee20e8521375e", "hex")
// trie.put(rlp.encode(0), t0, function () {})
// trie.put(rlp.encode(1), t1, function () {})

// all your ether are belong to us
